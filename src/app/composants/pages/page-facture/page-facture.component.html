<div class="container mt-4">

  <h2 class="mb-3">Liste des factures</h2>

  <!-- Barre de recherche simplifiée -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input type="text" class="form-control" placeholder="Rechercher par nom du client"
             [(ngModel)]="filtreNomClient" (input)="filtrerFactures()">
    </div>
    <div class="col-md-4 d-flex align-items-center gap-2">
      <select class="form-select" [(ngModel)]="filtreStatut" (change)="filtrerFactures()">
        <option value="">Tous les statuts</option>
        <option value="PAYEE">Payée</option>
        <option value="NON_PAYEE">Non payée</option>
        <option value="PARTIELLEMENT_PAYEE">En attente</option>
      </select>

      <input type="date" class="form-control" [(ngModel)]="filtreDate" (change)="filtrerFactures()" />
    </div>
    <div class="col-md-4 text-end">
       <button class="btn btn-info m-1" (click)="statistiqueFacture()"> <i class="bi bi-bar-chart-fill me-2"></i> Statistiques des factures</button>
      <button class="btn btn-success" (click)="exportCSV()">Exporter CSV</button>
    </div>
  </div>
 <!-- Edition statut -->
  <div *ngIf="factureEnEdition" class="card p-3 mt-4 mb-4">
    <h5>Modifier le statut de la facture #{{ factureEnEdition.id }}</h5>
    <select [(ngModel)]="factureEnEdition.statut" class="form-select mb-3">
      <option value="PAYEE">Payée</option>
      <option value="NON_PAYEE">Non payée</option>
      <option value="PARTIELLEMENT_PAYEE">En attente</option>
    </select>
    <button class="btn btn-success me-2" (click)="saveEditFacture()">Enregistrer</button>
    <button class="btn btn-secondary" (click)="cancelEdit()">Annuler</button>
  </div>

  <!-- Tableau des factures -->
  <table class="table table-bordered table-striped mt-3">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Client</th>
        <th>Montant total</th>
        <th>Statut</th>
        <th>Date facture</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let f of pagedFactures; let i = index">
        <td>{{ (page - 1) * pageSize + i + 1 }}</td> <!-- index comme commandes -->
        <td>{{ f.client?.prenom }} {{ f.client?.nom }}</td>
        <td>{{ f.montantTotal | currency:'XAF' }}</td> <!-- uniformisé avec pipe currency -->
        <td>
          <span class="badge bg-secondary">{{ f.statut }}</span>
        </td>
        <td>{{ f.dateFacture | date: 'dd/MM/yyyy' }}</td>
        <td class="text-nowrap text-center">
          <button class="btn btn-sm btn-warning me-1" (click)="imprimerFacture(f.id!)" title="Imprimer">
            <i class="bi bi-printer"></i>
          </button>
          <button class="btn btn-sm btn-info me-1" (click)="voirFacture(f.id!)" title="Voir">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm btn-primary me-1" (click)="editFacture(f.id!)" title="Modifier statut">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-danger" (click)="supprimerFacture(f.id!)" title="Supprimer">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
      <tr *ngIf="pagedFactures.length === 0">
        <td colspan="6" class="text-center">Aucune facture trouvée.</td>
      </tr>
    </tbody>
  </table>

  <!-- Pagination identique à commandes -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    <nav>
      <ul class="pagination mb-0">
        <li class="page-item" [class.disabled]="page === 1">
          <button class="page-link" (click)="page = page - 1; updatePagedFactures()">Précédent</button>
        </li>
        <li class="page-item disabled">
          <span class="page-link">{{ page }}</span>
        </li>
        <li class="page-item" [class.disabled]="page * pageSize >= (facturesFiltrees.length ? facturesFiltrees.length : factures.length)">
          <button class="page-link" (click)="page = page + 1; updatePagedFactures()">Suivant</button>
        </li>
      </ul>
    </nav>

    <select class="form-select w-auto" [(ngModel)]="pageSize" name="pageSize" (change)="updatePagedFactures()">
      <option [ngValue]="5">5 par page</option>
      <option [ngValue]="10">10 par page</option>
      <option [ngValue]="20">20 par page</option>
    </select>
  </div>

 
</div>
